{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Resources": {
    "Operations": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": "Custom-App-One-Operations",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Federated": {
                  "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:saml-provider/customer-saml"
                }
              },
              "Action": "sts:AssumeRoleWithSAML",
              "Condition": {
                "StringEquals": {
                  "SAML:aud": "https://signin.aws.amazon.com/saml"
                }
              }
            }
          ]
        },
        "Path": "/",
        "ManagedPolicyArns": [
          {
            "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:policy/customer_step_functions_policy"
          },
          {
            "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:policy/customer_eventbridge_policy"
          },
          {
            "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:policy/customer_systemsmanager_automation_policy"
          }
        ],
        "Policies": {
          "Type": "AWS::IAM::Policy",
          "Properties": {
            "PolicyName": "Custom-App-One-Operations-Invoke-Lambda",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "lambda:invokeFunction",
                  "Resource": {
                    "Fn::Sub": "arn:aws:lambda:us-east-1:{$AWS::AccountId}:function/custom_app_one_event_publisher*"
                  }
                }
              ]
            }
          }
        }
      }
    },
    "EventBridgeLambdaRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": "Custom-App-One-EventBridge-Lambda-Role",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": ["events.amazonaws.com"]
              },
              "Action": ["sts:AssumeRole"]
            }
          ]
        },
        "Path": "/",
        "RolePolicies": {
          "Type": "AWS::IAM::Policy",
          "Properties": {
            "PolicyName": "Custom-App-One-LambdaEvent-Policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "lambda:InvokeFunction",
                  "Resource": {
                    "Fn::Sub": "arn:aws:lambda:us-east-1:${AWS::AccountId}:function:custom_app_one_event_publisher_*"
                  }
                }
              ]
            }
          }
        }
      }
    },
    "EventBridgeStepFunctionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": "Custom-App-One-EventBridge-StepFunction-Role",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": ["events.amazonaws.com"]
              },
              "Action": ["sts:AssumeRole"]
            }
          ]
        },
        "Path": "/",
        "RolePolicies": {
          "Type": "AWS::IAM::Policy",
          "Properties": {
            "PolicyName": "Custom-App-One-EventBridge-StepFunction-Policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "states:StartExecution",
                  "Resource": {
                    "Fn::Sub": "arn:aws:states:us-east-1:${AWS::AccountId}:stateMachine:*"
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": "cloudwatch:GetMetricData",
                  "Resource": "*"
                }
              ]
            }
          }
        }
      }
    },
    "LambdaRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": "Custom-App-One-Lambda-Execution-Role",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": ["lambda.amazonaws.com"]
              },
              "Action": ["sts:AssumeRole"]
            }
          ]
        },
        "Path": "/",
        "ManagedPolicyArns": [
          {
            "Fn::Sub": "arn:aws:iam::${AWS::AccountId}:policy/AWSLambdaBasicExecutionRole"
          }
        ],
        "RolePolicies": {
          "Type": "AWS::IAM::Policy",
          "Properties": {
            "PolicyName": "Custom-App-One-Lambdas-Execution-Policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": "cloudwatch:GetMetricData",
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "autoscaling:DescribeAutoScalingInstances",
                    "autoscaling:DescribeAutoScalingGroups"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": ["events:PutEvents"],
                  "Resource": {
                    "Fn::Sub": "arn:aws:events:us-east-1:${AWS::AccountId}:event-bus/Custom-App-One-EventBus-*"
                  }
                }
              ]
            }
          }
        }
      }
    },
    "SSMRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": "Custom-App-One-SSM-Role",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": ["ssm.amazonaws.com"]
              },
              "Action": ["sts:AssumeRole"]
            }
          ]
        },
        "Path": "/",
        "RolePolicies": {
          "Type": "AWS::IAM::Policy",
          "Properties": {
            "PolicyName": "Custom-App-One-SSM-Policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": ["ssm:DescribeInstanceInformation"],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": ["ssm:SendCommand"],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:ec2:us-east-1:${AWS::AccountId}:instance/*"
                    },
                    "arn:aws:ssm:us-east-1::document/AWS-RunShellScript"
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": ["ssm:ListCommands", "ssm:ListCommandInvocations"],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "states:SendTaskFailure",
                    "states:SendTaskSuccess"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        }
      }
    },
    "StepFunctionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "RoleName": "Custom-App-One-StepFunction-Role",
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": { "Service": ["states.amazonaws.com"] },
              "Action": ["sts:AssumeRole"]
            }
          ]
        },
        "Path": "/",
        "RolePolicies": {
          "Type": "AWS::IAM::Policy",
          "Properties": {
            "PolicyName": "Custom-App-One-StepFunction-Policy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": ["lambda:InvokeFunction"],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:lambda:us-east-1:${AWS::AccountId}:function:custom_app_one_calculate_restart_plan_*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": ["sns:Publish"],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:sns:us-east-1:${AWS::AccountId}:Custom-App-One-Restart-Message-*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": ["ssm:StartAutomationExecution"],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:ssm:us-east-1:${AWS::AccountId}:automation-definition/Custom-App-One-RunCommand-*:*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": ["logs:CreateLogStream", "logs:PutLogEvents"],
                  "Resource": [
                    {
                      "Fn::Sub": "arn:aws:logs:*:${AWS::AccountId}:log-group:/aws/vendedlogs/states/custom_app_one-restart-Logs:*"
                    }
                  ]
                },
                {
                  "Effect": "Allow",
                  "Action": ["logs:CreateLogGroup"],
                  "Resource": {
                    "Fn::Sub": "arn:aws:logs:*:${AWS::AccountId}:*"
                  }
                }
              ]
            }
          }
        }
      }
    }
  }
}
